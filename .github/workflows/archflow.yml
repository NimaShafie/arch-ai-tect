name: ArchAiTect Pipeline

on:
  # 1) Use this to scaffold + auto-generate and open a PR for review
  workflow_dispatch:
    inputs:
      title:   { description: "Title (e.g., Payments Architecture)", required: true }
      slug:    { description: "Package ID (leave blank to slugify title)", required: false }
      owner:   { description: "Owner (e.g., Platform Team)", required: false, default: "Unassigned" }
      backend: { description: "openwebui | ollama | auto", required: false, default: "auto" }

  # 2) After PR is merged, these paths trigger the downstream jobs
  push:
    paths:
      - "packages/**"
      - "docs/**"
      - "mkdocs.yml"
      - "scripts/**"
      - "templates/_arch/**"

permissions:
  contents: write
  id-token: write
  pages: write
  pull-requests: write

env:
  # prefer repo Variables for non-secret knobs
  ARCHAI_MODEL: ${{ vars.ARCHAI_MODEL }} # e.g., qwen2.5:3b
  KROKI_URL: https://kroki.io

jobs:
  #######################################################################
  # A. PR CREATION PATH (manual trigger) â€” stops after opening the PR
  #######################################################################
  scaffold_and_generate:
    if: ${{ github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Ensure slugify is executable
        run: chmod +x scripts/slugify.sh || true

      - name: Compute inputs
        id: meta
        shell: bash
        run: |
          set -e
          TITLE="${{ inputs.title }}"
          OWNER="${{ inputs.owner }}"
          # Use provided slug, else slugify title
          if [ -n "${{ inputs.slug }}" ]; then
            PACKAGE_ID="${{ inputs.slug }}"
          else
            PACKAGE_ID="$(./scripts/slugify.sh "$TITLE")"
          fi
          echo "title=$TITLE"       >> $GITHUB_OUTPUT
          echo "owner=$OWNER"       >> $GITHUB_OUTPUT
          echo "package_id=$PACKAGE_ID" >> $GITHUB_OUTPUT
          echo "branch=archaitect/${PACKAGE_ID}/${{ github.run_id }}" >> $GITHUB_OUTPUT

      - name: Scaffold package from template (no push)
        shell: bash
        run: |
          set -e
          PID="${{ steps.meta.outputs.package_id }}"
          TITLE="${{ steps.meta.outputs.title }}"
          OWNER="${{ steps.meta.outputs.owner }}"

          if [ ! -d "packages/$PID" ]; then
            mkdir -p "packages/$PID"
            rsync -a templates/_arch/ "packages/$PID/"
            # token replacement
            find "packages/$PID" -type f -print0 | xargs -0 sed -i \
              -e "s/{{TITLE}}/$TITLE/g" \
              -e "s/{{OWNER}}/$OWNER/g" \
              -e "s/{{PACKAGE_ID}}/$PID/g"
            # docs page from template
            sed -e "s/{{TITLE}}/$TITLE/g" -e "s/{{OWNER}}/$OWNER/g" -e "s/{{PACKAGE_ID}}/$PID/g" \
              docs/packages/__template__.md > "docs/packages/$PID.md"
          fi

          # update catalog
          python3 - <<'PY'
import pathlib
root = pathlib.Path("packages")
items = sorted([p.name for p in root.iterdir() if p.is_dir()])
out = ["# Architecture Catalog", ""]
for s in items: out.append(f"- [{s}](packages/{s}.md)")
pathlib.Path("docs/catalog.md").write_text("\n".join(out)+"\n", encoding="utf-8")
PY

      - name: Validate intake is edited (fail fast if still template)
        shell: bash
        run: |
          PID="${{ steps.meta.outputs.package_id }}"
          if grep -q 'TBD' "packages/$PID/intake.yaml"; then
            echo "::error::Please edit packages/$PID/intake.yaml (replace TBDs) before generation."
            exit 1
          fi

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install generator deps
        run: pip install pyyaml requests

      - name: Generate package outputs via LLM
        env:
          OPENWEBUI_URL:     ${{ secrets.OPENWEBUI_URL }}
          OPENWEBUI_APIKEY:  ${{ secrets.OPENWEBUI_APIKEY }}
          OLLAMA_URL:        ${{ secrets.OLLAMA_URL }}
          ARCHAI_MODEL:      ${{ env.ARCHAI_MODEL }}
          ARCHAI_BACKEND:    ${{ inputs.backend }}
        run: |
          scripts/archaitect_generate.py "packages/${{ steps.meta.outputs.package_id }}/intake.yaml"

      - name: Create Pull Request (review path)
        uses: peter-evans/create-pull-request@v6
        with:
          branch: ${{ steps.meta.outputs.branch }}
          commit-message: "ArchAiTect: scaffold + auto-generate for ${{ steps.meta.outputs.package_id }}"
          title: "ArchAiTect: ${{ steps.meta.outputs.title }} (${{ steps.meta.outputs.package_id }})"
          body: |
            This PR was auto-generated by **ArchAiTect** from `intake.yaml`.

            - Package ID: `${{ steps.meta.outputs.package_id }}`
            - Owner: `${{ steps.meta.outputs.owner }}`
            - Backend: `${{ inputs.backend }}`
            - Model: `${{ env.ARCHAI_MODEL }}`

            Please review the generated docs and diagrams before merge.
          labels: |
            architecture
            archaitect
          add-paths: |
            packages/${{ steps.meta.outputs.package_id }}/**
            docs/packages/${{ steps.meta.outputs.package_id }}.md
            docs/catalog.md
          delete-branch: true

  #######################################################################
  # B. POST-MERGE PIPELINE (push to default branch)
  #######################################################################
  export_structurizr:
    if: ${{ github.event_name == 'push' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Export Structurizr DSL -> Mermaid + PlantUML (if present)
        shell: bash
        run: |
          set -e
          curl -sL https://github.com/structurizr/cli/releases/latest/download/structurizr-cli.zip -o cli.zip
          unzip -q cli.zip -d cli
          chmod +x cli/structurizr.sh
          found=0
          for dsl in packages/*/diagrams/structurizr/*.dsl; do
            [ -e "$dsl" ] || continue
            found=1
            base_dir=$(dirname "$dsl")/..
            cli/structurizr.sh export -workspace "$dsl" -format mermaid -output "$base_dir/mermaid"
            cli/structurizr.sh export -workspace "$dsl" -format plantuml/c4plantuml -output "$base_dir/plantuml"
          done
          [ "$found" = "0" ] && echo "No DSL files found, skipping."
      - uses: actions/upload-artifact@v4
        with: { name: exported, path: packages/**/diagrams/*/* }

  render_kroki:
    if: ${{ github.event_name == 'push' }}
    needs: export_structurizr
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Render PlantUML + Mermaid to SVG via Kroki
        shell: bash
        run: |
          set -e
          KROKI="${KROKI_URL}"
          shopt -s nullglob
          for f in packages/*/diagrams/plantuml/*.puml; do
            out="${f%/*}/../svg/$(basename "${f%.puml}").svg"
            mkdir -p "$(dirname "$out")"
            curl -s -X POST -H "Content-Type: text/plain" --data-binary @"$f" "$KROKI/plantuml/svg" > "$out"
          done
          for f in packages/*/diagrams/mermaid/*.mmd; do
            out="${f%/*}/../svg/$(basename "${f%.mmd}").svg"
            mkdir -p "$(dirname "$out")"
            curl -s -X POST -H "Content-Type: text/plain" --data-binary @"$f" "$KROKI/mermaid/svg" > "$out"
          done
      - uses: actions/upload-artifact@v4
        with: { name: diagrams-svg, path: packages/**/diagrams/svg/*.svg }

  build_docs:
    if: ${{ github.event_name == 'push' }}
    needs: render_kroki
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.12" }
      - run: python -m pip install mkdocs mkdocs-material mkdocs-macros-plugin
      - name: Build site
        run: mkdocs build --strict
      - uses: actions/upload-pages-artifact@v3
        with: { path: site }

  publish_docs:
    if: ${{ github.event_name == 'push' }}
    needs: build_docs
    runs-on: ubuntu-latest
    steps:
      - uses: actions/deploy-pages@v4

  jira_handoff:
    if: ${{ github.event_name == 'push' }}
    needs: render_kroki
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Create Jira issues from JSON (per package)
        uses: rmeneely/create-jira-issues@v1
        with:
          input: packages/**/jira_issues.json
          url: ${{ secrets.JIRA_URL }}
          user_email: ${{ secrets.JIRA_USER_EMAIL }}
          api_token: ${{ secrets.JIRA_API_TOKEN }}
        continue-on-error: true
      - name: Link workflow/deploys to Jira (optional)
        uses: chrnorm/deployment-action@releases/v1
        with:
          environment: "architecture"
          description: "Docs & diagrams published"

  notion_handoff:
    if: ${{ github.event_name == 'push' }}
    needs: render_kroki
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Node
        uses: actions/setup-node@v4
        with: { node-version: 20 }
      - name: Install Notion SDK
        run: npm -y add @notionhq/client
      - name: Create Notion tasks
        env:
          NOTION_TOKEN:      ${{ secrets.NOTION_API_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
        run: node scripts/notion-publish.js

  sync_disney_repo:
    if: ${{ github.event_name == 'push' }}
    needs: render_kroki
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Push Mermaid docs to SevDev21/disney-ai-plus
        uses: cpina/github-action-push-to-another-repository@main
        env:
          SSH_DEPLOY_KEY: ${{ secrets.DISNEY_REPO_DEPLOY_KEY }}
        with:
          source-directory: packages
          destination-github-username: "SevDev21"
          destination-repository-name: "disney-ai-plus"
          user-email: "actions@users.noreply.github.com"
          target-branch: "master"
          target-directory: "docs/diagrams"
          commit-message: "Sync Mermaid diagrams from ArchAiTect"
          rsync-args: "-av --include='*/' --include='*/diagrams/mermaid/*.mmd' --exclude='*'"
